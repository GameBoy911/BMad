# 优化的 IDE 开发工作流

这是一个简单的分步指南，旨在帮助您使用 BMad 方法高效地管理您的开发工作流。该工作流在整个开发生命周期中集成了测试架构师（QA 代理），以确保质量、防止回归并保持高标准。任何此处未涵盖的场景，请参阅 **[<ins>用户指南</ins>](user-guide.md)**。

## 创建新分支

1.  **开始新分支**

## 故事创建 (Scrum Master)

1.  **开始新的聊天/对话**
2.  **加载 SM 代理**
3.  **执行**：`*draft` (运行 create-next-story 任务)
4.  **评审生成的故事**，位于 `docs/stories/`
5.  **更新状态**：将状态从“草稿”更改为“已批准”

## 故事实施 (开发人员)

1.  **开始新的聊天/对话**
2.  **加载 Dev 代理**
3.  **执行**：`*develop-story {selected-story}` (运行 execute-checklist 任务)
4.  **评审生成的报告**，位于 `{selected-story}`

## 在整个工作流中集成测试架构师

测试架构师 (Quinn) 在整个开发生命周期中提供全面的质量保证。以下是如何在适当的时候利用其各项功能。

**命令别名：** 文档中使用的是完整命令 (`*risk-profile`, `*test-design`, `*nfr-assess`, `*trace-requirements`) 的缩写形式 (`*risk`, `*design`, `*nfr`, `*trace`)。

### 快速命令参考

| **阶段** | **命令** | **目的** | **输出** | **优先级** |
| --- | --- | --- | --- | --- |
| **故事批准后** | `*risk` | 识别集成和回归风险 | `docs/qa/assessments/{epic}.{story}-risk-{YYYYMMDD}.md` | 对于复杂/遗留项目为高 |
| | `*design` | 为开发创建测试策略 | `docs/qa/assessments/{epic}.{story}-test-design-{YYYYMMDD}.md` | 对于新功能为高 |
| **开发期间** | `*trace` | 验证测试覆盖率 | `docs/qa/assessments/{epic}.{story}-trace-{YYYYMMDD}.md` | 中 |
| | `*nfr` | 验证非功能性质量属性 | `docs/qa/assessments/{epic}.{story}-nfr-{YYYYMMDD}.md` | 对于关键功能为高 |
| **开发后** | `*review` | 全面评估 | QA 结果记入故事 + `docs/qa/gates/{epic}.{story}-{slug}.yml` | **必需** |
| **评审后** | `*gate` | 更新质量决策 | 更新 `docs/qa/gates/{epic}.{story}-{slug}.yml` | 按需 |

### 阶段 1：故事创建后 (开发开始前)

**推荐 - 为开发人员的成功做好准备：**

```bash
# 1. 风险评估 (对于复杂故事，首先运行)
@qa *risk {approved-story}
# 识别：
#   - 技术债务影响
#   - 集成复杂度
#   - 回归可能性 (1-9 评分)
#   - 缓解策略
# 关键适用场景：遗留项目、API 变更、数据迁移

# 2. 测试设计 (其次运行，以指导实施)
@qa *design {approved-story}
# 提供：
#   - 每个验收标准的测试场景
#   - 测试级别建议 (单元/集成/E2E)
#   - 基于风险的优先级 (P0/P1/P2)
#   - 测试数据要求
# 与开发人员分享：包含在故事评论中或附加到工单上
```

### 阶段 2：开发期间 (实施中期检查点)

**开发人员自助质量检查：**

```bash
# 3. 需求追溯 (在开发中期验证覆盖率)
@qa *trace {story-in-progress}
# 验证：
#   - 所有验收标准都有测试
#   - 没有遗漏的测试场景
#   - 适当的测试级别
#   - Given-When-Then 文档的清晰度
# 运行时间：编写完初始测试后

# 4. NFR 验证 (检查非功能性质量属性)
@qa *nfr {story-in-progress}
# 评估：
#   - 安全性：认证、授权、数据保护
#   - 性能：响应时间、资源使用
#   - 可靠性：错误处理、恢复
#   - 可维护性：代码质量、文档
# 运行时间：在标记“准备好评审”之前
```

### 阶段 3：故事评审 (质量门评估)

**必需 - 全面的测试架构评审：**

**先决条件：** 所有测试在本地通过；代码风格和类型检查通过。

```bash
# 5. 全面评审 (标准评审流程)
@qa *review {completed-story}
```

**评审期间会发生什么：**

1.  **深度代码分析**
    *   架构模式合规性
    *   代码质量和可维护性
    *   安全漏洞扫描
    *   性能瓶颈检测

2.  **主动重构**
    *   在安全的情况下直接改进代码
    *   立即修复明显的问题
    *   为开发人员建议复杂的重构

3.  **测试验证**
    *   所有级别 (单元/集成/E2E) 的覆盖率
    *   测试质量 (无不稳定测试，正确的断言)
    *   回归测试的充分性

4.  **质量门决策**
    *   创建：`docs/qa/gates/{epic}.{story}-{slug}.yml`
    *   添加：QA 结果部分到故事文件中
    *   状态：通过 (PASS)/关注 (CONCERNS)/失败 (FAIL)/豁免 (WAIVED)

### 阶段 4：评审后 (解决问题后)

**修复后更新质量门状态：**

```bash
# 6. 更新质量门 (记录最终决定)
@qa *gate {reviewed-story}
# 更新：质量门的新状态
# 使用场景：在解决评审反馈后
# 记录：修复了什么，豁免了什么
```

### 理解质量门决策

| **状态** | **含义** | **需要采取的行动** | **能否继续？** |
| --- | --- | --- | --- |
| **PASS (通过)** | 所有关键需求均已满足 | 无 | ✅ 是 |
| **CONCERNS (关注)** | 发现非关键问题 | 建议团队评审 | ⚠️ 谨慎进行 |
| **FAIL (失败)** | 存在严重问题 (安全问题、缺少P0测试) | 必须修复 | ❌ 否 |
| **WAIVED (豁免)** | 问题已知悉并被接受 | 记录原因 | ✅ 需获批准 |

### 基于风险的测试策略

测试架构师使用风险评分来确定测试的优先级：

| **风险分数** | **计算方式** | **测试优先级** | **对质量门的影响** |
| --- | --- | --- | --- |
| **9** | 高可能性 × 高影响 | P0 - 必须彻底测试 | 如果未测试则失败 (FAIL) |
| **6** | 中高组合 | P1 - 应该充分测试 | 如果存在差距则关注 (CONCERNS) |
| **4** | 中等组合 | P1 - 应该测试 | 如果存在明显差距则关注 (CONCERNS) |
| **2-3** | 中低组合 | P2 - 有则更佳 | 在评审中注明 |
| **1** | 风险极小 | P2 - 最低限度 | 在评审中注明 |

### 特殊情况与最佳实践

#### 高风险或遗留项目故事

```bash
# 始终按此顺序运行：
@qa *risk {story}    # 首先 - 识别危险
@qa *design {story}  # 其次 - 规划防御
# 然后在开发期间：
@qa *trace {story}   # 验证回归覆盖率
@qa *nfr {story}     # 检查性能影响
# 最后：
@qa *review {story}  # 深度集成分析
```

#### 复杂集成

*   在开发过程中多次运行 `*trace`
*   专注于集成测试覆盖率
*   使用 `*nfr` 验证跨系统性能
*   评审时要特别注意 API 合约

#### 性能关键特性

*   尽早并频繁运行 `*nfr` (不仅仅在评审时)
*   在变更前建立性能基线
*   记录可接受的性能下降范围
*   在 `*design` 中考虑负载测试要求

### 强制执行的测试质量标准

Quinn 确保所有测试都符合这些标准：

*   **无不稳定测试**：正确的异步处理、显式等待
*   **无硬编码等待**：只使用动态策略 (轮询、事件)
*   **无状态**：测试可以独立并并行运行
*   **自我清理**：测试管理自己的测试数据
*   **适当的分层**：单元测试用于逻辑，集成测试用于交互，E2E 测试用于用户旅程
*   **清晰的断言**：将断言保留在测试中，而不是深藏在辅助函数里

### 文档与审计追踪

所有测试架构师的活动都会创建永久记录：

*   **评估报告**：带时间戳的分析报告，位于 `docs/qa/assessments/`
*   **质量门文件**：决策记录，位于 `docs/qa/gates/`
*   **故事更新**：QA 结果部分记录在故事文件中
*   **可追溯性**：维护从需求到测试的映射关系

## 提交变更并推送

1.  **提交变更**
2.  **推送到远程仓库**

## 完整的开发周期流程

### 包含测试架构师的完整工作流

1.  **SM**：创建下一个故事 → 评审 → 批准
2.  **QA (可选)**：风险评估 (`*risk`) → 测试设计 (`*design`)
3.  **开发**：实施故事 → 编写测试 → 完成
4.  **QA (可选)**：开发中期检查 (`*trace`, `*nfr`)
5.  **开发**：标记为准备好评审
6.  **QA (必需)**：评审故事 (`*review`) → 做出质量门决策
7.  **开发 (如果需要)**：解决问题
8.  **QA (如果需要)**：更新质量门 (`*gate`)
9.  **提交**：所有变更
10. **推送**：到远程仓库
11. **继续**：直到所有功能都实现

### 快速决策指南

**我应该运行测试架构师命令吗？**

| **场景** | **开发前** | **开发中** | **开发后** |
| --- | --- | --- | --- |
| **简单的错误修复** | 可选 | 可选 | 必需 `*review` |
| **新功能** | 推荐 `*risk`, `*design` | 可选 `*trace` | 必需 `*review` |
| **遗留项目变更** | **必需** `*risk`, `*design` | 推荐 `*trace`, `*nfr` | 必需 `*review` |
| **API 修改** | **必需** `*risk`, `*design` | **必需** `*trace` | 必需 `*review` |
| **性能关键** | 推荐 `*design` | **必需** `*nfr` | 必需 `*review` |
| **数据迁移** | **必需** `*risk`, `*design` | **必需** `*trace` | 必需 `*review` + `*gate` |

### 成功指标

测试架构师有助于实现：

*   生产环境中**零回归缺陷**
*   **100% 需求测试覆盖率**
*   清晰的“通过/不通过”决策**质量门**
*   **文档化的技术债务风险接受**
*   团队间**一致的测试质量**
*   通过早期风险识别实现**测试左移**
